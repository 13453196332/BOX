function saveMessage(e,s){const t=JSON.parse(localStorage.getItem("chatHistory"))||[];t.push({message:e,type:s,timestamp:(new Date).toISOString()}),localStorage.setItem("chatHistory",JSON.stringify(t))}function loadMessages(){return JSON.parse(localStorage.getItem("chatHistory"))||[]}const messageList=document.getElementById("messageList"),messageContent=document.getElementById("messageContent"),submitBtn=document.getElementById("submitBtn"),systemTimestamp=document.getElementById("systemTimestamp");function loadChatHistory(){loadMessages().forEach((({message:e,type:s,timestamp:t})=>{displayMessage(e,s,new Date(t))}))}function displayMessage(e,s,t=new Date){const n=document.createElement("div");n.classList.add("message-item",s);const a=document.createElement("div");a.classList.add("message-bubble"),"received"===s?a.innerHTML=marked.parse(e):a.textContent=e;const o=document.createElement("div");o.classList.add("timestamp"),o.textContent=`${"sent"===s?"你":"DeepSeek"} ${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}`,a.appendChild(o),n.appendChild(a),messageList.appendChild(n),messageList.scrollTop=messageList.scrollHeight}function sendMessage(){const e=messageContent.value.trim();if(e){displayMessage(e,"sent"),saveMessage(e,"sent"),messageContent.value="",messageContent.style.height="auto";fetchDeepSeekResponse(e,displayLoadingMessage())}}function displayLoadingMessage(){const e=["加载中","加载中.","加载中..","加载中..."];let s=0;const t=document.createElement("div");t.classList.add("message-item","received","loading"),t.setAttribute("id","loadingMessage");const n=document.createElement("div");return n.classList.add("message-bubble"),n.textContent=e[s],t._intervalId=setInterval((()=>{s=(s+1)%e.length,n.textContent=e[s]}),500),t.appendChild(n),messageList.appendChild(t),messageList.scrollTop=messageList.scrollHeight,"loadingMessage"}function removeLoadingMessage(e){const s=document.getElementById(e);s&&(s._intervalId&&clearInterval(s._intervalId),messageList.removeChild(s))}function fetchDeepSeekResponse(e,s){fetch("https://api.deepseek.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer sk-4d4479dd52564ee4b369d83e9b4072f1"},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:"你是一个友好的AI助手，可以帮助用户解答各种问题。请用自然、亲切的语气与用户交流。"},{role:"user",content:e}],temperature:.7,max_tokens:2e3,enable_internet:!0})}).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{if(removeLoadingMessage(s),!(e&&e.choices&&e.choices[0]&&e.choices[0].message))throw console.error("Invalid API response:",e),new Error("Invalid response format");{const s=e.choices[0].message.content;displayMessage(s,"received"),saveMessage(s,"received")}})).catch((t=>{removeLoadingMessage(s),console.error("Error:",t),t.message.includes("Failed to fetch")?displayErrorMessage("无法连接到服务器，请检查您的网络连接。",e):displayErrorMessage("抱歉，服务暂时出现问题，请稍后再试。",e)}))}function displayErrorMessage(e,s=null){const t=document.createElement("div");t.classList.add("message-item","received","error-message");const n=document.createElement("div");if(n.classList.add("message-bubble"),n.textContent=e,s){const e=document.createElement("button");e.classList.add("refresh-button"),e.innerHTML="&#x21bb;",e.addEventListener("click",(()=>{const e=displayLoadingMessage();fetchDeepSeekResponse(s,e)})),n.appendChild(e)}t.appendChild(n),messageList.appendChild(t),messageList.scrollTop=messageList.scrollHeight,saveMessage(e,"received")}submitBtn.addEventListener("click",sendMessage),messageContent.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())})),loadChatHistory();