function saveMessage(e,t){const s=JSON.parse(localStorage.getItem("chatHistory"))||[];s.push({message:e,type:t,timestamp:(new Date).toISOString()}),localStorage.setItem("chatHistory",JSON.stringify(s))}function loadMessages(){return JSON.parse(localStorage.getItem("chatHistory"))||[]}const messageList=document.getElementById("messageList"),messageContent=document.getElementById("messageContent"),submitBtn=document.getElementById("submitBtn"),systemTimestamp=document.getElementById("systemTimestamp");function loadChatHistory(){loadMessages().forEach((({message:e,type:t,timestamp:s})=>{displayMessage(e,t,new Date(s))}))}function displayMessage(e,t,s=new Date){const a=document.createElement("div");a.className="chat-row "+("sent"===t?"user":"ai");const n=document.createElement("div");n.className="chat-avatar",n.innerHTML="sent"===t?'<i class="fas fa-user"></i>':'<i class="fas fa-robot"></i>';const o=document.createElement("div");o.className="chat-bubble","received"===t?o.innerHTML=marked.parse(e):o.textContent=e;const i=document.createElement("div");i.className="chat-timestamp",i.textContent=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`,a.appendChild(n),a.appendChild(o),a.appendChild(i),messageList.appendChild(a),messageList.scrollTop=messageList.scrollHeight}function displayLoadingMessage(){const e=["加载中","加载中.","加载中..","加载中..."];let t=0;const s=document.createElement("div");s.className="chat-row ai loading",s.setAttribute("id","loadingMessage");const a=document.createElement("div");a.className="chat-avatar",a.innerHTML='<i class="fas fa-robot"></i>';const n=document.createElement("div");n.className="chat-bubble",n.textContent=e[t],s._intervalId=setInterval((()=>{t=(t+1)%e.length,n.textContent=e[t]}),500),s.appendChild(a),s.appendChild(n);const o=document.createElement("div");o.className="chat-timestamp";const i=new Date;return o.textContent=`${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`,s.appendChild(o),messageList.appendChild(s),messageList.scrollTop=messageList.scrollHeight,"loadingMessage"}function removeLoadingMessage(e){const t=document.getElementById(e);t&&(t._intervalId&&clearInterval(t._intervalId),messageList.removeChild(t))}function sendMessage(){const e=messageContent.value.trim();if(e){displayMessage(e,"sent"),saveMessage(e,"sent"),messageContent.value="",messageContent.style.height="auto";fetchDeepSeekResponse(e,displayLoadingMessage())}}function fetchDeepSeekResponse(e,t){fetch("https://api.deepseek.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer sk-4d4479dd52564ee4b369d83e9b4072f1"},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:"你是一个友好的AI助手，可以帮助用户解答各种问题。请用自然、亲切的语气与用户交流。"},{role:"user",content:e}],temperature:.7,max_tokens:2e3,enable_internet:!0})}).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{if(removeLoadingMessage(t),!(e&&e.choices&&e.choices[0]&&e.choices[0].message))throw console.error("Invalid API response:",e),new Error("Invalid response format");{const t=e.choices[0].message.content;displayMessage(t,"received"),saveMessage(t,"received")}})).catch((s=>{removeLoadingMessage(t),console.error("Error:",s),s.message.includes("Failed to fetch")?displayErrorMessage("无法连接到服务器，请检查您的网络连接。",e):displayErrorMessage("抱歉，服务暂时出现问题，请稍后再试。",e)}))}function displayErrorMessage(e,t=null){const s=document.createElement("div");s.className="chat-row ai error-message";const a=document.createElement("div");a.className="chat-avatar",a.innerHTML='<i class="fas fa-robot"></i>';const n=document.createElement("div");if(n.className="chat-bubble",n.textContent=e,t){const e=document.createElement("button");e.classList.add("refresh-button"),e.innerHTML="&#x21bb;",e.addEventListener("click",(()=>{const e=displayLoadingMessage();fetchDeepSeekResponse(t,e)})),n.appendChild(e)}s.appendChild(a),s.appendChild(n);const o=document.createElement("div");o.className="chat-timestamp";const i=new Date;o.textContent=`${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`,s.appendChild(o),messageList.appendChild(s),messageList.scrollTop=messageList.scrollHeight,saveMessage(e,"received")}submitBtn.addEventListener("click",sendMessage),messageContent.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())})),loadChatHistory();