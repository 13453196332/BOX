function saveMessage(e,s){const t=JSON.parse(localStorage.getItem("chatHistory"))||[];t.push({message:e,type:s,timestamp:(new Date).toISOString()}),localStorage.setItem("chatHistory",JSON.stringify(t))}function loadMessages(){return JSON.parse(localStorage.getItem("chatHistory"))||[]}const messageList=document.getElementById("messageList"),messageContent=document.getElementById("messageContent"),submitBtn=document.getElementById("submitBtn"),systemTimestamp=document.getElementById("systemTimestamp");function loadChatHistory(){loadMessages().forEach((({message:e,type:s,timestamp:t})=>{displayMessage(e,s,new Date(t))}))}function displayMessage(e,s,t=new Date){const a=document.createElement("div");a.classList.add("message-item",s);const n=document.createElement("div");n.classList.add("message-bubble"),n.textContent=e;const o=document.createElement("div");o.classList.add("timestamp"),o.textContent=`${"sent"===s?"你":"DeepSeek"} ${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}`,n.appendChild(o),a.appendChild(n),messageList.appendChild(a),messageList.scrollTop=messageList.scrollHeight}function sendMessage(){const e=messageContent.value.trim();if(e){displayMessage(e,"sent"),saveMessage(e,"sent"),messageContent.value="",messageContent.style.height="auto";fetchDeepSeekResponse(e,displayLoadingMessage())}}function displayLoadingMessage(){const e=document.createElement("div");e.classList.add("message-item","received","loading"),e.setAttribute("id","loadingMessage");const s=document.createElement("div");return s.classList.add("message-bubble"),s.textContent="加载中...",e.appendChild(s),messageList.appendChild(e),messageList.scrollTop=messageList.scrollHeight,"loadingMessage"}function removeLoadingMessage(e){const s=document.getElementById(e);s&&messageList.removeChild(s)}function fetchDeepSeekResponse(e,s){fetch("https://api.deepseek.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer sk-4d4479dd52564ee4b369d83e9b4072f1"},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:"你是一个友好的AI助手，可以帮助用户解答各种问题。请用自然、亲切的语气与用户交流。"},{role:"user",content:e}],temperature:.7,max_tokens:2e3})}).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{if(removeLoadingMessage(s),!(e&&e.choices&&e.choices[0]&&e.choices[0].message))throw console.error("Invalid API response:",e),new Error("Invalid response format");{const s=e.choices[0].message.content;displayMessage(s,"received"),saveMessage(s,"received")}})).catch((e=>{removeLoadingMessage(s),console.error("Error:",e),e.message.includes("Failed to fetch")?displayErrorMessage("无法连接到服务器，请检查您的网络连接。"):displayErrorMessage("抱歉，服务暂时出现问题，请稍后再试。")}))}function displayErrorMessage(e){displayMessage(e,"received"),saveMessage(e,"received")}submitBtn.addEventListener("click",sendMessage),messageContent.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())})),loadChatHistory();